<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="top-bar">
    <h2>Welcome, <%= user.username %>! 👋</h2>
    <button id="darkModeToggle">🌙</button>
  </div>

  <form id="searchForm">
    <input type="text" id="query" placeholder="Search city or term..." required>
    <button type="submit">Search</button>
  </form>

  <h3>Results:</h3>
  <div id="result" class="card fade"></div>

  <h3>Your Search History:</h3>
  <ul id="historyList">
    <% if (user.history.length === 0) { %>
      <li>No search history yet.</li>
    <% } else { %>
      <% user.history.slice(-5).reverse().forEach(item => { %>
        <li><%= item %></li>
      <% }) %>
    <% } %>
  </ul>

  <a href="/logout">Logout</a>

  <script>
    const form = document.getElementById('searchForm');
    const result = document.getElementById('result');
    const historyList = document.getElementById('historyList');
    const toggle = document.getElementById('darkModeToggle');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const q = document.getElementById('query').value;
      result.innerHTML = "<p>Loading...</p>";
      result.classList.remove('visible');

      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();

        const weather = data.weather;
        const wiki = data.wiki;

        result.innerHTML = `
          <div class="card">
            <h3>🌤️ Weather in ${weather.name}, ${weather.sys.country}</h3>
            <p>
              <img class="weather-icon" src="http://openweathermap.org/img/wn/${weather.weather[0].icon}@2x.png" alt="icon">
              <strong>${weather.weather[0].main}</strong>: ${weather.weather[0].description}
            </p>
            <p>🌡️ Temp: ${weather.main.temp}°C (Feels like: ${weather.main.feels_like}°C)</p>
            <p>💧 Humidity: ${weather.main.humidity}% | Pressure: ${weather.main.pressure} hPa</p>
            <p>💨 Wind: ${weather.wind.speed} m/s, ${weather.wind.deg}°</p>
          </div>

          <div class="card">
            <h3>📘 Wikipedia Summary: ${wiki.title}</h3>
            <p>${wiki.extract}</p>
            <p><a href="${wiki.content_urls.desktop.page}" target="_blank">Read more</a></p>
          </div>
        `;

        setTimeout(() => result.classList.add('visible'), 100);

        if (data.history) {
          historyList.innerHTML = '';
          data.history.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            historyList.appendChild(li);
          });
        }

      } catch (err) {
        result.innerHTML = `<p style="color:red;">⚠️ Error fetching data: ${err.message}</p>`;
      }
    });

    // 🌙 Dark Mode Toggle
    toggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      toggle.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
    });
  </script>
</body>
</html>
