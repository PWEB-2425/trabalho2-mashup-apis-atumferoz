<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <script>
    // Persist dark mode before render
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>
</head>
<body class="dashboard" style="background-image: url('https://media.sketchfab.com/models/f996c2489cfc435eb79399ad1890f8e0/thumbnails/27bbc96613894664a78995dfe460ef03/8b0b0966602d4bafb967c3a11c19ab3f.jpeg'); background-size: cover; background-position: center;">


  <div class="top-bar">
    <h2>Welcome, <%= user.username %>!</h2>
    <button id="darkModeToggle">🌙</button>
  </div>

  <form id="searchForm">
    <input id="query" placeholder="Search city..." required>
    <button type="submit">Search</button>
  </form>

  <div id="result" class="card fade">
    <p>Search a city to see info here.</p>
  </div>

  <h3>Your Search History:</h3>
  <ul id="historyList">
    <% if (user.history.length === 0) { %>
      <li>No history yet.</li>
    <% } else { user.history.slice(-5).reverse().forEach(h => { %>
      <li><%= h %></li>
    <% }) } %>
  </ul>

  <a href="/logout">Logout</a>

  <script>
    const form = document.getElementById('searchForm');
    const result = document.getElementById('result');
    const historyList = document.getElementById('historyList');
    const toggle = document.getElementById('darkModeToggle');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      result.innerHTML = '<p>Loading...</p>';
      result.classList.remove('visible');

      const q = document.getElementById('query').value;

      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();

        const { weather, wiki, movies, tracks, images, history } = data;

result.innerHTML = `
  <div class="image-gallery">
    ${images.map(src => `<img class="location-img" src="${src}" alt="City image">`).join('')}
  </div>

  <div class="card">
    <h3>🌤️ Weather in ${weather.name}, ${weather.sys.country}</h3>
    <p><strong>${weather.weather[0].main}</strong>: ${weather.weather[0].description}</p>
    <p>Temp: ${weather.main.temp}°C (Feels like: ${weather.main.feels_like}°C)</p>
    <p>Humidity: ${weather.main.humidity}% | Pressure: ${weather.main.pressure} hPa</p>
    <p>Wind: ${weather.wind.speed} m/s</p>
  </div>

  <div class="card">
    <h3>📘 Wiki: ${wiki.title}</h3>
    <p>${wiki.extract}</p>
    <p><a href="${wiki.content_urls.desktop.page}" target="_blank">Read more</a></p>
  </div>

  ${movies.length ? `<div class="card"><h3>🎬 Top Movies</h3><ul>${movies.map(m => `<li>${m.title} (${m.release_date?.substring(0, 4) || ''})</li>`).join('')}</ul></div>` : ''}

  ${tracks.length ? `<div class="card"><h3>🎵 Popular Tracks</h3><ul>${tracks.map(t => `<li><a href="${t.url}" target="_blank">${t.name}</a> – ${t.artists}</li>`).join('')}</ul></div>` : ''}
`;


        setTimeout(() => result.classList.add('visible'), 100);

        historyList.innerHTML = '';
        history.forEach(h => {
          const li = document.createElement('li');
          li.textContent = h;
          historyList.appendChild(li);
        });

      } catch (err) {
        result.innerHTML = `<p style="color:red;">⚠️ Error: ${err.message}</p>`;
      }
    });

    toggle.addEventListener('click', () => {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      toggle.textContent = isDark ? '☀️' : '🌙';
    });
  </script>
</body>
</html>
